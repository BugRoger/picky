Array.prototype.index=function(a){for(var i=0,h=this.length;i<h;i++)if(this[i]==a)return i;return null};Array.prototype.include=function(a){return this.index(a)!==null};Array.prototype.remove=function(a){this.splice(a,1);return this};var PickyI18n={};$(function(){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en"});
var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(a){for(var i=PickyI18n.locale||
"en",h=a.split(".").concat(i),b=dictionary,e=0,o=h.length;e<o;e++){b=b[h[e]];if(b==undefined){b="Translation missing: "+a+"."+i;break}}return b};function Allocation(a,i,h,b,e,o){var p=this;this.type=a;this.weight=i;this.count=h;this.combination=b;this.ids=e||[];this.entries=this.rendered=o||[];this.isType=function(f){return f==p.type}}function Allocations(a){this.allocations=[];for(var i=0,h=a.length;i<h;i++){var b=a[i];this.allocations.push(new Allocation(b[0],b[1],b[2],b[3],b[4],b[5]))}this.length=this.allocations.length;this.each=function(e){return $.each(this.allocations,e)}}
function PickyData(a){var i=a.total,h=a.duration,b=a.offset;a=new Allocations(a.allocations||[]);this.total=i;this.duration=h;this.offset=b;this.allocations=a;this.isEmpty=function(){return i==0}};var PickyView=function(a,i){var h=i.showResultsLimit||10,b=$("#picky input.query"),e=$("#picky div.reset"),o=$("#picky input.search_button"),p=$("#picky div.status"),f=$("#picky .dashboard"),q=$("#picky .results"),u=$("#picky .no_results"),m=new PickyAddination(this,q),d=new PickyAllocationsCloud(this,i),k=new PickyResultsRenderer(m),c=function(){e.fadeTo(166,1)},j=function(){d.hide();q.empty();u.hide()},n=function(g){b.val(g);e.fadeTo(166,0);v("empty");p.empty();j()},s=function(){return b.val()};
this.text=s;var r=function(g){p.text(g);g>0&&g<=5&&p.fadeTo("fast",0.5).fadeTo("fast",1)},w=function(g){if(g.isEmpty())return"none";if(g.total>h&&g.allocations.length>1)return"support";return"ok"},v=function(g){f.attr("class","dashboard "+g)};this.insert=function(g){b.val(g);b.select()};this.fullResultsCallback=function(g){v(w(g));if(g.isEmpty()){j();r(0);u.show();c()}else if(g.total>h&&g.allocations.length>1){j();c();d.show(g);r(g.total)}else if(g.offset==0){j();r(g.total);k.render(g);q.show();c();
b.focus()}else{m.remove();k.render(g);$("body").animate({scrollTop:$("#picky div.results div.header:last").position().top-12},500)}};this.liveResultsCallback=function(g){v(w(g));r(g.total)};this.allocationChosen=function(g){g=g.data.query;b.val(g);a.allocationChosen(g)};this.addinationClicked=function(g){a.addinationClicked(s(),g)};(function(){b.keyup(function(g){if(s()==""){n();a.searchTextCleared()}else{a.searchTextEntered(s(),g);c()}});p.click(function(){s()==""||a.searchButtonClicked(s())});o.click(function(){s()==
""||a.searchButtonClicked(s())});e.click(function(){n("");a.clearButtonClicked();b.focus()})})();b.focus()};var PickyBackend=function(a){var i=function(h,b,e,o){var p=o||{};p=$.extend({query:h,offset:e},o);$.getJSON(a,p,function(f){b&&b(new PickyData(f))})};this.search=function(h,b,e,o,p){i(h,function(f){b&&b(p,f)},e,o)}},LiveBackend=function(a){var i=new PickyBackend(a);this.search=function(h,b,e,o,p){p=p||{};latestRequestTimestamp=new Date;p.live=latestRequestTimestamp;i.search(h,function(f,q){if(!f.live||f.live==latestRequestTimestamp)b&&b(q)},e,o,p)}},FullBackend=function(a){var i=new PickyBackend(a);
this.search=function(h,b,e,o,p){p=p||{};latestRequestTimestamp=new Date;p.full=latestRequestTimestamp;i.search(h,function(f,q){if(!f.full||f.full==latestRequestTimestamp)b&&b(q)},e,o,p)}};var PickyController=function(a){var i=new PickyView(this,a),h=a.backends,b=a.before||function(){},e=a.success||function(){},o=a.after||function(){},p=function(d,k){d=e(d,k)||d;i.liveResultsCallback(d);o(d,k)},f,q=function(){var d=i.text();b({});var k=h.live;k&&k.search(d,p,0,void 0);clearInterval(f)};f=setInterval(q,180);clearInterval(f);var u=function(d,k){d=e(d,k)||d;i.fullResultsCallback(d);o(d,k)},m=function(d,k,c){c=c||{};k=k||0;clearInterval(f);$.address&&$.address.parameter("q",d);c=b(c,d,
k)||c;var j=h.full;j&&j.search(d,u,k,c)};this.insert=function(d,k){i.insert(d);k&&m(d)};this.clearButtonClicked=function(){clearInterval(f)};this.searchTextCleared=function(){clearInterval(f)};this.searchTextEntered=function(d,k){if($.inArray(k.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(k.keyCode==13)m(d);else{clearInterval(f);f=setInterval(q,180)}};this.searchButtonClicked=function(d){m(d)};this.allocationChosen=
function(d){m(d)};this.addinationClicked=function(d,k){m(d,k.data.offset)}};var Localization={location_delimiters:{de:"in",fr:"\u00e0",it:"a",en:"in",ch:"in"},explanation_delimiters:{de:"und",fr:"et",it:"e",en:"and",ch:"und"}},PickyClient=function(a){Localization.qualifiers=a.qualifiers||{};Localization.explanations=a.explanations||{};Localization.explanation_delimiters={de:"und",fr:"et",it:"e",en:"and",ch:"und"};var i=a.backends;if(i){i.live||alert("Both a full and live backend must be provided.");i.full||alert("Both a full and live backend must be provided.")}else a.backends=
{live:a.live&&new LiveBackend(a.live)||alert("A live backend path must be provided."),full:a.full&&new FullBackend(a.full)||alert("A live backend path must be provided.")};var h=a.controller&&new a.controller(a)||new PickyController(a);var b=this.insert=function(e,o){h.insert(e,o||true)};this.insertFromURL=function(e){if(e&&e!="")b(e);else $.address&&b($.address.parameter("q"))};$.address&&$.address.externalChange(function(e){(e=e.parameters.q)&&b(e)})};var PickyAddination=function(a,i){this.remove=function(){i.find(".addination").remove()};this.render=function(h){var b=h.total,e;e=h.offset+20+0;var o=e+20;h=h.total;if(h<o)o=h;e={offset:e,start:e+1,end:o};if(e.offset<b){b=$("<div class='addination'>"+t("results.addination.more")+"</div>");b.bind("click",{offset:e.offset},a.addinationClicked);return b}else return""}};var PickyResultsRenderer=function(a){var i=["street_number","zipcode"],h=function(f){var q=f[f.length-1];f=f.slice(0,f.length-1);if(f==[])f=[f];if(!i.include(q[0]))if(q[1].match(/[^\*~]$/))q[1]+="*";f.push(q);return f},b=function(f){for(var q=Localization.explanations&&Localization.explanations[PickyI18n.locale]||{},u=[],m,d=0,k=f.length;d<k;d++){m=f[d];var c=m[0];c=q[c]||c;u.push([c,m[1]])}return u},e=function(f,q){return[f.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0]+)/,
"<strong>$1</strong>"),q].join(" ")},o=function(f,q){var u=Localization.explanation_delimiters[PickyI18n.locale],m=b(h(q)),d="",k=[];m=$.map(m,function(c){var j=c[0];c=c[1];if(d==""||j==d){k.push(c);d=j}else{var n=e(d,k.join(" "));k=[];k.push(c);d=j;return n}});m.push(e(d,k.join(" ")));m=m.join(" "+u+" ");return'<span class="explanation">'+f+" "+m+"</span>"},p=function(f,q){var u='<div class="header">';u+=o(q.type,q.combination);if(f.offset>0)u+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';
return u};this.render=function(f){var q=$("#picky div.results");f.allocations.each(function(u,m){q.append(p(f,m)).append('<ol class="results">'+m.entries.join("")+"</ol>").append(a.render(f))})}};function AllocationRenderer(a,i){function h(c){var j={},n={},s=[],r;r=0;for(l=c.length;r<l;r++){var w=c[r][0];if(w in j){j[w]=j[w]+" "+c[r][1];s.push(r)}else{j[w]=c[r][1];n[r]=w}}for(r in n)c[r][1]=j[n[r]];for(r=s.length-1;r>=0;r--)c.remove(s[r]);return c}function b(c){return $.map(c,function(j,n){return"%"+(n+1)+"$s"}).join(" ")}function e(c){if(c.length==0)return"";var j=c=h(c);j.sort(function(x,y){return x[0]<y[0]?-1:1});for(var n=[],s=0,r=j.length;s<r;s++)n.push(j[s][0]);var w=n.length==1,v=d[n]||
(d[n]=b(n));if($.type(v)==="string"){d[n]={format:v};v=d[n]}var g=1,z=v.format;$.each(c,function(x,y){var A=y[0],B=y[1];if(v.filter)B=v.filter(B);A=u[A]||A;if(w&&!(v&&v.ignoreSingle))return z=B+"&nbsp;("+A+")";z=z.replace(RegExp("%"+g+"\\$s","g"),B);g+=1;return g});return z}function o(c){for(var j=[],n=0,s=m.length;n<s;n++)j.push([]);j.push([]);n=0;for(s=c.length;n<s;n++){for(var r=c[n],w=r[0],v=false,g=0,z=m.length;g<z;g++)if(m[g].include(w)){j[g].push(r);v=true;break}v||j[j.length-1].push(r)}var x;
for(c=j.length-1;c>=0;c--){x=j[c];if(x.length>0)break}x=x[x.length-1];k.include(x[0])||(x[1]+="...");return $.map(j,function(y){return e(y)})}function p(c){var j=[],n,s;for(s in c){n=c[s][0];n=q[n]||n;j[s]=n+":"+c[s][1]}return j.join(" ")}var f=PickyI18n.locale,q=Localization.qualifiers&&Localization.qualifiers[f]||{},u=Localization.explanations&&Localization.explanations[f]||{},m=i.groups||[],d=i.choices||{};this.explanation=this.query=this.text="";var k=["street_number","zipcode"];this.contract=
h;this.rendered=e;this.groupify=o;this.querify=p;this.render=function(c){var j=c.combination,n=c.count;c=p(j);j=o(j).join(" ");j=$('<li><div class="text">'+j+'</div><div class="count">'+n+"</div></li>");j.bind("click",{query:c},a);return j}};var PickyAllocationsCloud=function(a,i){var h=$("#picky .allocations"),b=h.find(".shown"),e=h.find(".more"),o=h.find(".hidden"),p=function(){h.hide()},f=new AllocationRenderer(function(m){p();a.allocationChosen(m)},i),q=function(m){var d=[];m.each(function(k,c){d.push(f.render(c))});return d},u=function(m){if(m.length==0)return $("#search .allocations").hide();b.empty();e.hide();o.empty().hide();if(m.length>3){$.each(m.slice(0,2),function(d,k){b.append(k)});$.each(m.slice(2),function(d,k){o.append(k)});
e.show()}else $.each(m,function(d,k){b.append(k)});return $("#search .allocations").show()};e.click(function(){e.hide();o.show()});this.hide=p;this.show=function(m){u(q(m.allocations));h.show()}};
